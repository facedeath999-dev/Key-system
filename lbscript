-- ========== SETTINGS ==========
local ATTACK_RANGE = 200
local ATTACK_INTERVAL = 0.05
local CHEST_COOLDOWN = 1200 -- 20 minutes
local DEFAULT_WALKSPEED = 16
local WALK_SPEED = 30

local attackEnabled = false
local walkSpeedEnabled = false
local ignoreNPCs = false
local ignorePlayers = false
local ignoreTrainingPoles = false

-- ========== SERVICES ==========
local Players = game:GetService("Players")
local ReplicatedStorage = game:GetService("ReplicatedStorage")
local UserInputService = game:GetService("UserInputService")
local Workspace = game:GetService("Workspace")
local HttpService = game:GetService("HttpService")

local player = Players.LocalPlayer
local attackEvent = ReplicatedStorage:WaitForChild("Events"):WaitForChild("AttackV2")

-- ========== MEMORY ==========
local lootedChests = {}

-- ========== GUI PARENT ==========
local guiParent
pcall(function() guiParent = gethui() end)
if not guiParent then guiParent = player:WaitForChild("PlayerGui") end

-- ========== REMOTE KEY SYSTEM ==========
local REMOTE_KEY_URL = "https://raw.githubusercontent.com/facedeath999-dev/Key-system/639b2f2fbe6196eb0e776597307ef25798419684/Key.txt"

local function fetchRemoteKey()
    local success, key = pcall(function()
        return game:HttpGet(REMOTE_KEY_URL)
    end)
    if success and key then
        return key:gsub("%s","") -- remove newlines/whitespace
    else
        warn("Failed to fetch remote key")
        return nil
    end
end

-- Key GUI
local KeyGui = Instance.new("ScreenGui", guiParent)
KeyGui.Name = "Key_GUI"
KeyGui.ResetOnSpawn = false

local KeyFrame = Instance.new("Frame", KeyGui)
KeyFrame.Size = UDim2.new(0, 350, 0, 150)
KeyFrame.Position = UDim2.new(0.5, -175, 0.4, -75)
KeyFrame.BackgroundColor3 = Color3.fromRGB(20,20,20)
Instance.new("UICorner", KeyFrame).CornerRadius = UDim.new(0,12)

local KeyTitle = Instance.new("TextLabel", KeyFrame)
KeyTitle.Size = UDim2.new(1,-10,0.3,0)
KeyTitle.Position = UDim2.new(0,5,0,5)
KeyTitle.BackgroundTransparency = 1
KeyTitle.Text = "Enter Your Script Key"
KeyTitle.TextColor3 = Color3.fromRGB(0,255,128)
KeyTitle.Font = Enum.Font.GothamBold
KeyTitle.TextScaled = true

local KeyInput = Instance.new("TextBox", KeyFrame)
KeyInput.Size = UDim2.new(0.8,0,0.25,0)
KeyInput.Position = UDim2.new(0.1,0,0.4,0)
KeyInput.PlaceholderText = "Key Here"
KeyInput.Text = ""
KeyInput.ClearTextOnFocus = false
KeyInput.TextScaled = true
KeyInput.Font = Enum.Font.Gotham

local SubmitBtn = Instance.new("TextButton", KeyFrame)
SubmitBtn.Size = UDim2.new(0.6,0,0.2,0)
SubmitBtn.Position = UDim2.new(0.2,0,0.7,0)
SubmitBtn.Text = "Submit"
SubmitBtn.TextScaled = true
SubmitBtn.Font = Enum.Font.GothamBold
SubmitBtn.BackgroundColor3 = Color3.fromRGB(0,180,0)
SubmitBtn.TextColor3 = Color3.fromRGB(255,255,255)
Instance.new("UICorner", SubmitBtn).CornerRadius = UDim.new(0,8)

-- Wait for correct key
local function waitForKey()
    local validKey = fetchRemoteKey()
    if not validKey then return false end

    local keyEntered = false
    SubmitBtn.MouseButton1Click:Connect(function()
        if KeyInput.Text == validKey then
            KeyGui:Destroy()
            keyEntered = true
        else
            KeyInput.Text = ""
            KeyInput.PlaceholderText = "Wrong key!"
            KeyInput.TextColor3 = Color3.fromRGB(255,50,50)
        end
    end)

    repeat task.wait() until keyEntered
    return true
end

if not waitForKey() then return end -- stop script if key system fails

-- ========== MAIN SCRIPT MENU ==========
local sg = Instance.new("ScreenGui", guiParent)
sg.IgnoreGuiInset = true
sg.ResetOnSpawn = false

local MainFrame = Instance.new("Frame", sg)
MainFrame.Size = UDim2.new(0.3,0,0.6,0)
MainFrame.Position = UDim2.new(0.05,0,0.1,0)
MainFrame.BackgroundColor3 = Color3.fromRGB(20,20,20)
MainFrame.ClipsDescendants = true
Instance.new("UICorner", MainFrame).CornerRadius = UDim.new(0,12)

-- Header / Title
local Title = Instance.new("TextLabel", MainFrame)
Title.Size = UDim2.new(0.5,-10,0.06,0)
Title.Position = UDim2.new(0,5,0,5)
Title.BackgroundTransparency = 1
Title.Text = "ðŸŒ‘ TESTER HUB ðŸŒ‘"
Title.TextColor3 = Color3.fromRGB(0,255,128)
Title.Font = Enum.Font.GothamBold
Title.TextScaled = true
Title.TextXAlignment = Enum.TextXAlignment.Left
Title.TextYAlignment = Enum.TextYAlignment.Top

-- ========== DRAG ==========
local dragging, dragStart, startPos
MainFrame.InputBegan:Connect(function(i)
	if i.UserInputType == Enum.UserInputType.MouseButton1 or i.UserInputType == Enum.UserInputType.Touch then
		dragging = true
		dragStart = i.Position
		startPos = MainFrame.Position
	end
end)
MainFrame.InputEnded:Connect(function() dragging = false end)
UserInputService.InputChanged:Connect(function(i)
	if dragging and (i.UserInputType == Enum.UserInputType.MouseMovement or i.UserInputType == Enum.UserInputType.Touch) then
		local d = i.Position - dragStart
		MainFrame.Position = UDim2.new(startPos.X.Scale, startPos.X.Offset+d.X, startPos.Y.Scale, startPos.Y.Offset+d.Y)
	end
end)

-- ========== BUTTONS / SLIDER / CHECKBOXES ==========
local function makeButton(text,ypos)
	local b = Instance.new("TextButton", MainFrame)
	b.Size = UDim2.new(0.8,0,0.07,0)
	b.Position = UDim2.new(0.1,0,ypos,0)
	b.BackgroundColor3 = Color3.fromRGB(50,50,50)
	b.Text = text
	b.TextColor3 = Color3.fromRGB(255,255,255)
	b.Font = Enum.Font.GothamBold
	b.TextScaled = true
	Instance.new("UICorner", b).CornerRadius = UDim.new(0,8)
	return b
end

local AttackBtn = makeButton("AUTO ATTACK: OFF",0.25)
local WalkBtn = makeButton("WalkSpeed: OFF",0.35)

local function makeSlider(text,min,max,default,callback,ypos)
	local frame = Instance.new("Frame", MainFrame)
	frame.Size = UDim2.new(0.8,0,0.06,0)
	frame.Position = UDim2.new(0.1,0,ypos,0)
	frame.BackgroundTransparency = 1

	local label = Instance.new("TextLabel", frame)
	label.Size = UDim2.new(1,0,0.4,0)
	label.Position = UDim2.new(0,0,0,0)
	label.BackgroundTransparency = 1
	label.TextColor3 = Color3.fromRGB(255,255,255)
	label.Font = Enum.Font.Gotham
	label.TextScaled = true
	label.TextXAlignment = Enum.TextXAlignment.Left
	label.Text = text .. ": " .. string.format("%.2f",default)

	local bar = Instance.new("Frame", frame)
	bar.Size = UDim2.new(1,0,0.5,0)
	bar.Position = UDim2.new(0,0,0.5,0)
	bar.BackgroundColor3 = Color3.fromRGB(45,45,45)
	Instance.new("UICorner", bar)

	local fill = Instance.new("Frame", bar)
	fill.Size = UDim2.new((default-min)/(max-min),0,1,0)
	fill.BackgroundColor3 = Color3.fromRGB(0,140,255)
	Instance.new("UICorner", fill)

	local draggingSlider=false
	bar.InputBegan:Connect(function(i)
		if i.UserInputType==Enum.UserInputType.MouseButton1 or i.UserInputType==Enum.UserInputType.Touch then
			draggingSlider=true
		end
	end)
	UserInputService.InputChanged:Connect(function(i)
		if draggingSlider then
			local p = math.clamp((i.Position.X-bar.AbsolutePosition.X)/bar.AbsoluteSize.X,0,1)
			fill.Size = UDim2.new(p,0,1,0)
			local val = min+(max-min)*p
			label.Text=text..": "..string.format("%.2f",val)
			callback(val)
		end
	end)
	UserInputService.InputEnded:Connect(function() draggingSlider=false end)
	return frame
end

local AttackSlider = makeSlider("Attack Interval",0,0.10,ATTACK_INTERVAL,function(v) ATTACK_INTERVAL=v end,0.45)

local yCheck=0.55
local function makeCheck(text,cb)
	local b=Instance.new("TextButton",MainFrame)
	b.Size=UDim2.new(0.8,0,0.06,0)
	b.Position=UDim2.new(0.1,0,yCheck,0)
	b.BackgroundColor3=Color3.fromRGB(40,40,40)
	b.TextColor3=Color3.fromRGB(255,255,255)
	b.Font=Enum.Font.GothamBold
	b.TextScaled=true
	Instance.new("UICorner",b).CornerRadius=UDim.new(0,6)
	local on=false
	b.Text="[ ] "..text
	b.MouseButton1Click:Connect(function()
		on=not on
		b.Text=(on and "[âœ“] " or "[ ] ")..text
		cb(on)
	end)
	yCheck+=0.08
	return b
end

makeCheck("Ignore NPCs",function(v) ignoreNPCs=v end)
makeCheck("Ignore Players",function(v) ignorePlayers=v end)
makeCheck("Ignore Training Poles",function(v) ignoreTrainingPoles=v end)

-- Hide / Dot
local HideBtn=Instance.new("TextButton",MainFrame)
HideBtn.Size=UDim2.new(0.1,0,0.05,0)
HideBtn.Position=UDim2.new(0.88,0,0.01,0)
HideBtn.BackgroundColor3=Color3.fromRGB(80,0,0)
HideBtn.Text="Hide"
HideBtn.TextColor3=Color3.fromRGB(255,255,255)
HideBtn.Font=Enum.Font.GothamBold
HideBtn.TextScaled=true
Instance.new("UICorner",HideBtn).CornerRadius=UDim.new(0,6)

local DotButton=Instance.new("TextButton",sg)
DotButton.Size=UDim2.new(0,40,0,40)
DotButton.Position=UDim2.new(0.05,0,0.1,0)
DotButton.BackgroundColor3=Color3.fromRGB(0,180,0)
DotButton.Text="â˜°"
DotButton.TextColor3=Color3.fromRGB(255,255,255)
DotButton.TextScaled=true
DotButton.Visible=false
Instance.new("UICorner",DotButton).CornerRadius=UDim.new(0.5,0)

-- Drag Dot
local draggingDot,dotStart,dotPos=false,nil,nil
DotButton.InputBegan:Connect(function(i)
	if i.UserInputType == Enum.UserInputType.MouseButton1 or i.UserInputType == Enum.UserInputType.Touch then
		draggingDot=true
		dotStart=i.Position
		dotPos=DotButton.Position
	end
end)
DotButton.InputEnded:Connect(function() draggingDot=false end)
UserInputService.InputChanged:Connect(function(i)
	if draggingDot and (i.UserInputType == Enum.UserInputType.MouseMovement or i.UserInputType == Enum.UserInputType.Touch) then
		local d=i.Position-dotStart
		DotButton.Position=UDim2.new(dotPos.X.Scale,dotPos.X.Offset+d.X,dotPos.Y.Scale,dotPos.Y.Offset+d.Y)
	end
end)

HideBtn.MouseButton1Click:Connect(function()
	MainFrame.Visible=false
	DotButton.Visible=true
end)
DotButton.MouseButton1Click:Connect(function()
	MainFrame.Visible=true
	DotButton.Visible=false
end)

-- BUTTON LOGIC
AttackBtn.MouseButton1Click:Connect(function()
	attackEnabled=not attackEnabled
	AttackBtn.BackgroundColor3=attackEnabled and Color3.fromRGB(0,180,0) or Color3.fromRGB(50,50,50)
end)
WalkBtn.MouseButton1Click:Connect(function()
	walkSpeedEnabled=not walkSpeedEnabled
	local hum=player.Character and player.Character:FindFirstChildOfClass("Humanoid")
	if walkSpeedEnabled then
		WalkBtn.Text="WalkSpeed: ON"
		WalkBtn.BackgroundColor3=Color3.fromRGB(0,180,0)
		if hum then hum.WalkSpeed=WALK_SPEED end
	else
		WalkBtn.Text="WalkSpeed: OFF"
		WalkBtn.BackgroundColor3=Color3.fromRGB(50,50,50)
		if hum then hum.WalkSpeed=DEFAULT_WALKSPEED end
	end
end)

-- AUTO ATTACK LOOP
task.spawn(function()
	while true do
		task.wait(ATTACK_INTERVAL)
		if attackEnabled then
			local t
			local root = player.Character and player.Character:FindFirstChild("HumanoidRootPart")
			if root then
				local folder = Workspace:FindFirstChild("Characters")
				if folder then
					for _,ch in ipairs(folder:GetChildren()) do
						if ch:FindFirstChild("HumanoidRootPart") and ch:FindFirstChildOfClass("Humanoid") and ch.Humanoid.Health>0 then
							if ignoreTrainingPoles and ch.Name=="TrainingPole" then continue end
							if ignoreNPCs and ch.Name:find("NPC") then continue end
							local p = Players:GetPlayerFromCharacter(ch)
							if p and ignorePlayers then continue end
							if (root.Position-ch.HumanoidRootPart.Position).Magnitude<=ATTACK_RANGE then
								t=ch
								break
							end
						end
					end
				end
			end
			if t then attackEvent:FireServer(2,1,t,{IgnoreEvasion=true}) end
		end
	end
end)

-- WalkSpeed Maintenance
task.spawn(function()
	while true do
		task.wait(0.1)
		if walkSpeedEnabled then
			local hum=player.Character and player.Character:FindFirstChildOfClass("Humanoid")
			if hum then hum.WalkSpeed=WALK_SPEED end
		end
	end
end)

-- Chest Collection
task.spawn(function()
	while true do
		task.wait(0.3)
		if not attackEnabled then continue end
		local root=player.Character and player.Character:FindFirstChild("HumanoidRootPart")
		if not root then continue end
		local enemies=Workspace:FindFirstChild("Characters")
		local hasEnemies=false
		if enemies then for _,t in ipairs(enemies:GetChildren()) do if t:FindFirstChild("Humanoid") and t.Humanoid.Health>0 then hasEnemies=true break end end end
		if hasEnemies then continue end
		local chestsFolder=Workspace:FindFirstChild("Chests")
		if not chestsFolder then continue end
		local nearestChest,nearestDist
		for _,c in ipairs(chestsFolder:GetChildren()) do
			if c:IsA("Model") and c:FindFirstChildWhichIsA("ProximityPrompt") then
				if lootedChests[c] and tick()-lootedChests[c]<CHEST_COOLDOWN then continue end
				local d=(root.Position-c:GetModelCFrame().Position).Magnitude
				if not nearestDist or d<nearestDist then nearestChest=c; nearestDist=d end
			end
		end
		if nearestChest then
			root.CFrame=nearestChest:GetModelCFrame()+Vector3.new(0,3,0)
			task.wait(0.5)
			local prompt=nearestChest:FindFirstChildWhichIsA("ProximityPrompt")
			if prompt then prompt:InputHoldBegin(); task.wait(prompt.HoldDuration or 0.5); prompt:InputHoldEnd() end
			lootedChests[nearestChest]=tick()
			task.wait(0.5)
		end
	end
end)